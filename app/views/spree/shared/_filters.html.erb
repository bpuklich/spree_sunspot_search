<% url_options = { "action" => "filter" }.merge(params)
  url_options.merge!(controller.filter_url_settings) if controller.respond_to?(:filter_url_settings)
%>
<% unless Spree::Sunspot::Setup.query_filters.filters.empty? %>
  <%= form_tag url_options, :method => :get, :id => "sidebar_products_search" do %>
    <% Spree::Sunspot::Setup.query_filters.filters.each do |filter| %>
      <% if lookup_context.find_all("spree/filters/_#{filter.search_param}").any? %>
        <%= render :partial => "spree/filters/#{filter.search_param}", :locals => { :filter => filter }%>
      <% else %>
        <% if @searcher.solr_search.facet(filter.search_param).is_a?(Sunspot::Search::FieldFacet) %>
          <% next if @searcher.solr_search.facet(filter.search_param).rows.empty? %>
          <nav class="sidebar-item" data-field="<%= filter.search_param %>">
              <h4 class="filter-title"><%= Spree.t :shop_by_taxonomy, :taxonomy => filter.display_name %></h4>
              <ul class="filter_choices list-group">
                  <% @searcher.solr_search.facet(filter.search_param).rows.sort{|a,b| a.value.downcase <=> b.value.downcase}.each do |row| %>
                    <li class="list-group-item">
                        <% selected = params[:s][filter.search_param].include? row.value.to_s if params[:s] and params[:s][filter.search_param].present? %>
                        <% checkbox_id = "#{filter.search_param}_#{row.value}" %>
                        <% count = row.try(:count) || 0 %>
                        <span class='badge'><%= count %></span>
                        <label class="filter_field <%= count > 0 ? 'nonzero' : 'zero' %>" for="<%= checkbox_id %>">
                            <%= check_box_tag "s[#{filter.search_param}][]", row.value, selected, { :id => checkbox_id } %>
                            <%= "#{row.instance.try(:name) || row.value}".html_safe %>
                        </label>
                    </li>
                  <% end %>
              </ul>
          </nav>
        <% else %>
          <% next unless filter.display? %>
          <nav class="sidebar-item" data-field="<%= filter.search_param %>">
            <h4 class="filter-title"><%= Spree.t :shop_by_taxonomy, :taxonomy => filter.display_name %></h4>
            <ul class="filter_choices list-group">
              <% solr_search = @searcher.solr_search %>
              <% solr_rows = solr_search.facet(filter.search_param).rows %>
              <% filter.html_values.each_with_index do |hv, index| %>
                <li class="list-group-item">
                  <% selected = params[:s][filter.search_param].include? hv[:value].to_s if params[:s] and params[:s][filter.search_param].present? %>
                  <% checkbox_id = "#{filter.search_param}_#{hv[:value]}" %>
                  <% count = solr_rows.find{|r| r.value == hv[:orig_value]}.try(:count) || 0 %>
                  <span class='badge'><%= count %></span>
                  <label class="filter_field <%= count > 0 ? 'nonzero' : 'zero' %>" for="<%= checkbox_id %>">
                    <%= check_box_tag "s[#{filter.search_param}][]", hv[:value], selected, { :id => checkbox_id } %>
                    <%= "#{hv[:display]}".html_safe %>
                  </label>
                </li>
              <% end %>
            </ul>
          </nav>
        <% end %>
      <% end %>
    <% end %>
    <%= submit_tag Spree.t(:search), :class => 'btn btn-primary' %>
    <%= link_to Spree.t(:clear_all), "javascript: $('.filter_choices input').attr('checked', false);", :class => 'filter_clear_all btn btn-default' %>
  <% end %>
<% end %>
